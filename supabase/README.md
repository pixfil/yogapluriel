# üóÑÔ∏è Database Migrations & Setup

> Guide complet pour g√©rer la base de donn√©es Supabase du boilerplate

---

## üìÅ Structure

```
supabase/
‚îú‚îÄ‚îÄ migrations/              # ‚ö†Ô∏è Migrations originales (FormDeToit)
‚îÇ                            # √Ä utiliser comme r√©f√©rence
‚îÇ
‚îú‚îÄ‚îÄ migrations_organized/    # ‚úÖ Structure recommand√©e pour nouveau projet
‚îÇ   ‚îú‚îÄ‚îÄ 00_core/            # OBLIGATOIRE - Syst√®me de base
‚îÇ   ‚îú‚îÄ‚îÄ 01_content/         # Recommand√© - Gestion contenu
‚îÇ   ‚îú‚îÄ‚îÄ 02_system/          # Recommand√© - Features syst√®me
‚îÇ   ‚îú‚îÄ‚îÄ 03_communication/   # Recommand√© - Formulaires & emails
‚îÇ   ‚îî‚îÄ‚îÄ 04_optional/        # Optionnel - Features avanc√©es
‚îÇ
‚îú‚îÄ‚îÄ seeds/                   # Donn√©es de d√©mo & admin initial
‚îÇ   ‚îú‚îÄ‚îÄ 01_core.sql         # Admin + settings (OBLIGATOIRE)
‚îÇ   ‚îî‚îÄ‚îÄ 02_demo_content.sql # Exemples (optionnel)
‚îÇ
‚îú‚îÄ‚îÄ rls/                     # Row Level Security
‚îÇ   ‚îú‚îÄ‚îÄ functions.sql       # Fonctions helper RLS
‚îÇ   ‚îî‚îÄ‚îÄ policies.sql        # Toutes les RLS policies
‚îÇ
‚îú‚îÄ‚îÄ storage/                 # Supabase Storage
‚îÇ   ‚îî‚îÄ‚îÄ buckets.sql         # Configuration des buckets
‚îÇ
‚îî‚îÄ‚îÄ README.md               # Ce fichier
```

---

## üöÄ Quick Start

### Option A : Installation Manuelle (Recommand√© pour d√©butants)

**1. Cr√©er un projet Supabase**
- Aller sur https://supabase.com
- Cr√©er nouveau projet
- Noter l'URL et les cl√©s API

**2. Appliquer les migrations**
- Ouvrir **SQL Editor** dans Supabase Dashboard
- Copier-coller chaque fichier `.sql` dans l'ordre num√©rique

```
üìå ORDRE D'APPLICATION :

00_core/ (OBLIGATOIRE)
  001_extensions.sql
  002_user_profiles.sql
  003_site_settings.sql
  004_email_logs.sql
  005_audit_logs.sql

01_content/ (Recommand√©)
  010_projects.sql (ou portfolio_items)
  011_team.sql
  012_faq.sql
  013_lexique.sql
  014_categories.sql
  015_certifications.sql

02_system/ (Recommand√©)
  020_redirects.sql
  021_404_logs.sql
  022_popups.sql
  023_pages_seo.sql

03_communication/ (Recommand√©)
  030_contacts.sql
  031_newsletter.sql
  032_quote_requests.sql
  033_job_applications.sql (optionnel)

04_optional/ (Optionnel)
  040_ai_chatbot.sql
  041_rag_documents.sql
  042_calculator.sql
```

**3. Appliquer RLS**
```sql
-- Dans SQL Editor, ex√©cuter dans l'ordre :
rls/functions.sql
rls/policies.sql
```

**4. Configurer Storage**
```sql
storage/buckets.sql
```

**5. Ins√©rer donn√©es initiales**
```sql
seeds/01_core.sql          -- OBLIGATOIRE (cr√©e admin)
seeds/02_demo_content.sql  -- Optionnel (exemples)
```

---

### Option B : Avec Supabase CLI (Avanc√©)

```bash
# 1. Installer CLI
npm install -g supabase

# 2. Lier votre projet
supabase link --project-ref xxxyyyzz

# 3. Appliquer migrations
supabase db push

# 4. (Optionnel) Appliquer seeds
supabase db seed

# Note : Cette m√©thode n√©cessite que les migrations soient
# dans le bon format CLI (voir docs Supabase)
```

---

## üìã Modules D√©taill√©s

### 00_core/ (OBLIGATOIRE)

**Tables cr√©√©es :**
- `user_profiles` - Extension de auth.users avec r√¥les
- `site_settings` - Configuration site (key-value)
- `email_logs` - Tracking emails envoy√©s
- `audit_logs` - Journal d'activit√© admin
- `activity_logs` - Logs syst√®me

**Extensions activ√©es :**
- `uuid-ossp` - G√©n√©ration UUID
- `pgcrypto` - Encryption

**‚ö†Ô∏è Sans ce module, rien ne fonctionne !**

---

### 01_content/ (Recommand√©)

**Tables :**
- `portfolio_items` (ou `projects`) - Portfolio/r√©alisations
- `team` - Membres √©quipe
- `faq` - Questions fr√©quentes
- `lexique` - Glossaire/termes
- `categories` - Cat√©gories pour contenus
- `certifications` - Labels/certifications

**Utilisez si :**
- Vous avez un portfolio/projets
- Vous pr√©sentez une √©quipe
- Vous voulez une FAQ
- Vous avez des termes techniques √† expliquer

---

### 02_system/ (Recommand√©)

**Tables :**
- `redirects` - Redirections SEO (301/302)
- `404_logs` - Tracking erreurs 404
- `popups` - Notifications programmables
- `pages_seo` - Pages SEO dynamiques

**Utilisez si :**
- Vous migrez un ancien site (redirects)
- Vous voulez tracker les 404
- Vous voulez des popups promo
- Vous g√©rez des pages SEO

---

### 03_communication/ (Recommand√©)

**Tables :**
- `contacts` - Formulaire contact / Inbox
- `newsletter_subscribers` - Abonn√©s newsletter
- `newsletter_campaigns` - Campagnes email
- `quote_requests` - Demandes de devis
- `job_applications` - Candidatures emploi

**Utilisez si :**
- Vous avez un formulaire de contact
- Vous envoyez une newsletter
- Vous collectez des demandes (devis, inscription, etc.)

---

### 04_optional/ (Optionnel)

**Tables :**
- `ai_chatbot_settings` - Config chatbot IA
- `rag_documents` - Documents pour RAG
- `embeddings` - Embeddings vectoriels
- `calculator_submissions` - Formulaire calculateur

**Utilisez si :**
- Vous voulez un chatbot IA
- Vous avez un calculateur sp√©cifique

---

## üîê Row Level Security (RLS)

### Pourquoi c'est Important

**RLS = S√©curit√© au niveau de la base de donn√©es**

M√™me si votre code a une faille, la DB prot√®ge les donn√©es !

```sql
-- Exemple : Public ne peut voir que le contenu publi√©
CREATE POLICY "Public can view published"
  ON projects FOR SELECT
  TO anon, authenticated
  USING (published = true AND deleted_at IS NULL);

-- Admins peuvent tout faire
CREATE POLICY "Admins can manage all"
  ON projects FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid()
      AND (roles @> '["super_admin"]' OR roles @> '["admin"]')
    )
  );
```

### Fichiers RLS

**`rls/functions.sql`** - Fonctions helper
- `is_admin()` - V√©rifie si user est admin
- `has_role(role)` - V√©rifie un r√¥le sp√©cifique
- `can_delete()` - V√©rifie permissions delete
- etc.

**`rls/policies.sql`** - Toutes les policies
- √Ä appliquer APR√àS les migrations
- Une policy par op√©ration (SELECT, INSERT, UPDATE, DELETE)
- Policies diff√©rentes par r√¥le

---

## üóëÔ∏è Soft Delete Pattern

### Qu'est-ce que c'est ?

Au lieu de **supprimer d√©finitivement**, on marque comme "supprim√©".

**Avantages :**
- ‚úÖ R√©cup√©ration possible
- ‚úÖ Audit trail (qui a supprim√© quoi quand)
- ‚úÖ Conformit√© l√©gale

### Comment √ßa Marche

**Chaque table a :**
```sql
deleted_at TIMESTAMPTZ    -- NULL = actif, DATE = supprim√©
deleted_by UUID          -- Qui a supprim√©
```

**Suppression (soft delete) :**
```sql
UPDATE projects
SET deleted_at = NOW(), deleted_by = auth.uid()
WHERE id = '...';
```

**Restauration :**
```sql
UPDATE projects
SET deleted_at = NULL, deleted_by = NULL
WHERE id = '...';
```

**Suppression d√©finitive (super admin seulement) :**
```sql
DELETE FROM projects WHERE id = '...';
```

**Filtrer les supprim√©s dans les queries :**
```sql
SELECT * FROM projects
WHERE deleted_at IS NULL  -- Exclure supprim√©s
ORDER BY created_at DESC;
```

---

## üì§ Supabase Storage

### Buckets Configur√©s

| Bucket | Usage | Taille Max | Public |
|--------|-------|------------|--------|
| `avatars` | Photos users | 2 MB | Oui |
| `project-images` | Images portfolio | 5 MB | Oui |
| `team-photos` | Photos √©quipe | 5 MB | Oui |
| `documents` | PDFs/Docs | 10 MB | Non |
| `newsletter-pdfs` | Newsletters | 10 MB | Oui |

### Policies Storage

```sql
-- Public peut lire
CREATE POLICY "Public images accessible"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id IN ('project-images', 'team-photos'));

-- Authenticated peut uploader
CREATE POLICY "Users can upload"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id IN ('project-images', 'avatars'));
```

---

## üîÑ Cr√©er une Nouvelle Migration

### M√©thode 1 : Fichier SQL Manuel

```bash
# 1. Cr√©er fichier
touch supabase/migrations_organized/999_my_feature.sql

# 2. √âcrire SQL
# Exemple :
CREATE TABLE my_table (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE my_table ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public can view"
  ON my_table FOR SELECT
  TO public
  USING (true);

# 3. Appliquer via SQL Editor Supabase
```

### M√©thode 2 : Supabase CLI

```bash
# G√©n√©rer migration
supabase migration new my_feature

# √âditer le fichier g√©n√©r√©
# Puis appliquer
supabase db push
```

---

## üîß Maintenance

### R√©g√©n√©rer Types TypeScript

```bash
# Apr√®s CHAQUE modification de sch√©ma
npm run db:types

# Ou manuellement
npx supabase gen types typescript \
  --project-id xxxyyyzz \
  > src/lib/database.types.ts
```

### V√©rifier RLS

```sql
-- Lister toutes les policies
SELECT schemaname, tablename, policyname, cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename;

-- V√©rifier qu'une table a RLS activ√©
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

### Reset DB (DEV seulement !)

```bash
# ‚ö†Ô∏è ATTENTION : Supprime TOUTES les donn√©es !
supabase db reset
```

---

## üìö Ressources

- [Supabase Docs](https://supabase.com/docs)
- [PostgreSQL Docs](https://www.postgresql.org/docs/)
- [RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Storage Guide](https://supabase.com/docs/guides/storage)
- [CLI Reference](https://supabase.com/docs/reference/cli)

---

## ‚ö†Ô∏è Notes Importantes

### Migrations Originales (dossier `migrations/`)

Ces fichiers viennent de FormDeToit (projet en production).
- ‚úÖ Utilisez-les comme **r√©f√©rence**
- ‚úÖ Voyez comment sont structur√©es les tables
- ‚ùå Ne les appliquez PAS directement (beaucoup de doublons/fixes)

Pour un nouveau projet, utilisez `migrations_organized/` qui est une version nettoy√©e.

### Ordre d'Application

**TOUJOURS respecter l'ordre :**
1. Core (00_)
2. Content (01_)
3. System (02_)
4. Communication (03_)
5. Optional (04_)
6. RLS
7. Storage
8. Seeds

### Sauvegardes

Supabase fait des backups automatiques, mais :
- ‚úÖ Testez d'abord sur un projet de DEV
- ‚úÖ Exportez avant migrations majeures
- ‚úÖ Gardez vos scripts SQL en version control

---

**üöÄ Pr√™t ? ‚Üí Voir [Quick Start Guide](../docs/01-QUICK-START.md)**
